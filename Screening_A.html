<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Mental Health Screening (Educational — Not a Diagnosis)</title>
<style>
  :root{
    --bg:#0b0f14;
    --card:#0f172a;
    --card2:#111827;
    --text:#e9eef6;
    --muted:#94a3b8;
    --accent:#02D3E9;
    --accent2:#06FF00;
    --border:rgba(255,255,255,.10);
    --shadow:0 12px 35px rgba(0,0,0,.35);
    --hi:#7CFFB2;
    --med:#FFD166;
    --lo:#94a3b8;
    --warn:#ffcc66;
    --danger:#ff5c7a;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  html,body{margin:0;background:radial-gradient(1200px 800px at top,#111827 0%,#0b0f14 60%);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,system-ui;line-height:1.55}
  .topbar{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(11,15,20,.98),rgba(11,15,20,.86));backdrop-filter:blur(10px);border-bottom:1px solid var(--border);}
  .wrap{max-width:1040px;margin:0 auto;padding:18px}
  .topbar .wrap{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 18px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
  .title1{font-weight:900;letter-spacing:.2px}
  .tiny{font-size:12px;color:var(--muted)}
  .btnrow{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  button{border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
  button:hover{border-color:rgba(255,255,255,.20)}
  button.primary{background:linear-gradient(90deg,rgba(2,211,233,.22),rgba(6,255,0,.10));border-color:rgba(2,211,233,.35)}
  button.danger{background:rgba(255,92,122,.12);border-color:rgba(255,92,122,.35)}
  button.ghost{background:transparent}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--text);font-family:inherit;font-size:14px;box-sizing:border-box}
  input::placeholder,textarea::placeholder{color:var(--muted)}
  input:focus,select:focus,textarea:focus{outline:none;border-color:rgba(2,211,233,.55);box-shadow:0 0 0 2px rgba(2,211,233,.15)}
  h1{margin:0;font-size:32px;letter-spacing:-.4px}
  h2{margin:0;font-size:20px}
  h3{margin:0;font-size:16px}
  .card{background:linear-gradient(180deg,rgba(17,24,39,.92),rgba(15,23,42,.92));border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .hr{height:1px;background:var(--border);margin:10px 0}
  .pill{font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);background:rgba(255,255,255,.02)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1 1 auto}
  .progressWrap{display:flex;align-items:center;gap:12px}
  .bar{flex:1;height:10px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--border)}
  .bar > div{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
  .kbd{font-family:var(--mono);font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:8px;background:rgba(255,255,255,.03)}
  .warnbox{border:1px solid rgba(255,204,102,.35);background:rgba(255,204,102,.08);border-radius:14px;padding:12px;color:#ffe3b0}
  .dangerbox{border:1px solid rgba(255,92,122,.40);background:rgba(255,92,122,.10);border-radius:14px;padding:12px;color:#ffd0d9}
  .q{padding:12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.02);margin-top:10px}
  .qtext{font-weight:750;line-height:1.35}
  .qhelp{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35}
  .opts{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .opt{padding:8px 14px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02);cursor:pointer;user-select:none;font-size:13px;transition:all .15s ease}
  .opt:hover{border-color:rgba(2,211,233,.55)}
  .opt.sel{border-color:rgba(2,211,233,.55);background:linear-gradient(135deg,rgba(2,211,233,.22),rgba(6,255,0,.10))}
  .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 900px){.twoCol{grid-template-columns:1fr}}
  .hidden{display:none !important}
  .table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
  .table th,.table td{border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top}
  .table th{color:var(--muted);font-weight:800;text-align:left}
  .right{text-align:right}
  .high{color:var(--hi);font-weight:800}
  .med{color:var(--med);font-weight:800}
  .low{color:var(--lo);font-weight:800}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  pre{white-space:pre-wrap;background:rgba(255,255,255,.03);border:1px solid var(--border);padding:12px;border-radius:14px;font-family:var(--mono);font-size:12px;line-height:1.45}
  @media print{
    .topbar,#secActions,#btnBack,#btnReset,#btnSubmit,#btnPrint,#btnClear,#btnSaveNow,#btnLoad,#btnExportJSON{display:none!important}
    body{background:#fff;color:#000}
    .card{box-shadow:none;border:1px solid #ddd;background:#fff}
    .q{border:1px solid #ddd}
    a{color:#000;text-decoration:underline}
  }
</style>
</head>

<body>
<div class="topbar">
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title1">Mental Health Screening Questionnaire</div>
        <div class="tiny">Educational screening support — not a diagnosis</div>
      </div>
    </div>
    <div class="btnrow">
      <button id="btnSaveNow" class="ghost">Save</button>
      <button id="btnLoad" class="ghost">Load</button>
      <button id="btnClear" class="danger">Clear Saved</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div class="progressWrap">
        <div>
          <div style="font-weight:900">Progress</div>
          <div class="tiny">Autosave: <span id="autosaveState">ready</span></div>
        </div>
        <div class="bar"><div id="barFill"></div></div>
        <div class="tiny"><span id="answeredCount">0</span> / <span id="visibleCount">0</span> answered</div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <span class="pill">Mode: <b id="modeLabel">Adult</b></span>
        <span class="pill">Results: <b>Screening %</b></span>
        <span class="pill">Unlocked sections: <b id="visSecCount">0</b></span>
      </div>
    </div>
  </div>

  <!-- FORM PAGE -->
  <div class="grid" id="formPage">

    <div class="card">
      <h1>Mental Health Screening Questionnaire</h1>
      <p class="tiny" style="margin-top:6px;color:var(--muted);">
        This tool looks for patterns in how you’ve been feeling and functioning. It produces <b>screening matches</b> to guide a conversation with a clinician.
        <br><b>This is not a diagnosis</b> and not medical advice.
      </p>
      <div class="hr"></div>
      <div class="dangerbox">
        <b>Safety:</b> If you are in immediate danger or thinking about harming yourself or someone else, seek emergency help now (local emergency number, crisis line, or ER).
      </div>
      <div class="hr"></div>

      <div class="twoCol">
        <div>
          <div style="font-weight:900;margin-bottom:6px;">How to answer</div>
          <ul style="margin:8px 0 0 18px;color:var(--muted);line-height:1.55">
            <li>Answer based on the past few weeks unless the question says otherwise.</li>
            <li>If symptoms are mainly from alcohol/drugs/meds or a medical issue, mark that in the rule-out section.</li>
            <li>Some sections only show if your answers suggest they’re relevant.</li>
          </ul>
        </div>
        <div>
          <div style="font-weight:900;margin-bottom:6px;">Mode</div>
          <div class="q" style="margin-top:0">
            <div class="qtext">Who is this screening for?</div>
            <div class="qhelp">“Child/Adolescent” mode changes some content and adds a few age-specific items.</div>
            <div class="opts" id="ageModeOpts"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="sec_demographics">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2>Basic Info (optional)</h2>
          <div class="tiny">Used only to label your results.</div>
        </div>
        <span class="badge">Optional</span>
      </div>
      <div class="twoCol">
        <div class="q" style="margin-top:10px">
          <div class="qtext">Name</div>
          <input id="dem_name" type="text" placeholder="Full name" autocomplete="name" />
        </div>
        <div class="q" style="margin-top:10px">
          <div class="qtext">Age</div>
          <input id="dem_age" type="number" min="0" max="120" placeholder="Age" inputmode="numeric" />
        </div>
      </div>
      <div class="twoCol">
        <div class="q">
          <div class="qtext">Sex</div>
          <input id="dem_sex" type="text" placeholder="Sex" />
        </div>
        <div class="q">
          <div class="qtext">Gender identity</div>
          <input id="dem_gender" type="text" placeholder="Gender identity" />
        </div>
      </div>
      <div class="twoCol">
        <div class="q">
          <div class="qtext">Sexual orientation</div>
          <input id="dem_orientation" type="text" placeholder="Sexual orientation" />
        </div>
        <div class="q">
          <div class="qtext">Race</div>
          <input id="dem_race" type="text" placeholder="Race" />
        </div>
      </div>
      <div class="twoCol">
        <div class="q">
          <div class="qtext">Have you been to therapy before or sought treatment before?</div>
          <div class="opts">
            <div class="opt" onclick="selectDemOption(this, 'dem_therapy', 'No')">No</div>
            <div class="opt" onclick="selectDemOption(this, 'dem_therapy', 'Yes')">Yes</div>
          </div>
        </div>
        <div class="q">
          <div class="qtext">Have you been diagnosed ever?</div>
          <div class="opts">
            <div class="opt" onclick="selectDemOption(this, 'dem_diagnosed', 'No')">No</div>
            <div class="opt" onclick="selectDemOption(this, 'dem_diagnosed', 'Yes')">Yes</div>
          </div>
        </div>
      </div>
      <div class="q">
        <div class="qtext">If so, what with?</div>
        <textarea id="dem_diagnosis" rows="3" placeholder="List any prior diagnoses here..."></textarea>
      </div>
      <div class="hr"></div>
      <div class="warnbox">
        <div style="font-weight:900;margin-bottom:8px;">Acknowledgment</div>
        <p style="margin:0 0 10px 0;line-height:1.5;">
          By completing this form, I acknowledge that I am voluntarily filling it out. I understand that names on the form will be redacted, but the data may be used to help improve this screening tool and help others. All information will be kept confidential and used only for educational and improvement purposes.
        </p>
        <label style="display:flex;gap:10px;align-items:center;cursor:pointer;">
          <input type="checkbox" id="dem_acknowledge" style="width:auto;cursor:pointer;" />
          <span>I acknowledge and agree to the above terms</span>
        </label>
      </div>
    </div>

    <!-- CORE GATES -->
    <div class="card" id="sec_core">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2>1) Start Here (Core Gates)</h2>
          <div class="tiny">These decide which sections unlock next. Answer them first.</div>
        </div>
        <div class="tiny"><span class="kbd">Tip</span> If a section doesn’t appear, it didn’t unlock.</div>
      </div>
      <div id="coreQuestions"></div>
    </div>

    <!-- RULE-OUTS -->
    <div class="card" id="sec_confounds">
      <div>
        <h2>2) Rule-Outs (Medical, Sleep, Substance, Grief)</h2>
        <div class="tiny">These reduce false positives (symptoms that have a better explanation).</div>
      </div>
      <div id="confoundQuestions"></div>
    </div>

    <!-- SYMPTOM SECTIONS (GATED) -->
    <div class="card" id="sec_domains">
      <div>
        <h2>3) Symptom Check (Shared Question Bank)</h2>
        <div class="tiny">Questions are reused across multiple conditions so we don’t repeat the same thing 12 times.</div>
      </div>
      <div id="domainSections"></div>
    </div>

    <div class="card" id="secActions">
      <div class="row">
        <button id="btnSubmit" class="primary">Submit</button>
        <button id="btnReset" class="ghost">Reset (form only)</button>
        <button id="btnExportJSON" class="ghost">Export JSON</button>
      </div>
      <p class="tiny" style="margin-top:8px;">
        Submit hides the form and shows results full-page. PDF export: <span class="kbd">Print → Save as PDF</span>.
      </p>
    </div>
  </div>

  <!-- RESULTS PAGE -->
  <div class="grid hidden" id="resultsPage">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <h2 style="font-size:22px;margin:0 0 6px 0;">Results (Screening Matches)</h2>
          <p class="tiny" style="color:var(--muted);margin:0">
            These results are <b>not a diagnosis</b>. They are screening-level matches based on your answers.
            Bring this to a licensed professional for proper assessment.
          </p>
        </div>
        <div class="btnrow">
          <button id="btnBack" class="ghost">Back to Form</button>
          <button id="btnPrint" class="primary">Print / Save PDF</button>
        </div>
      </div>

      <div class="warnbox" style="margin-top:10px;">
        <b>Important:</b> Screening percentages are not certainty. They reflect how strongly your answers match common symptom patterns
        after applying rule-outs (medical/substance/sleep/grief).
      </div>

      <div class="row" id="demographicsSummary" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <div class="twoCol">
        <div class="card" style="box-shadow:none">
          <div style="font-weight:900">Top matches</div>
          <div class="tiny">Highest matches after rule-outs and confidence adjustments.</div>
          <table class="table" id="topMatchesTable"></table>
        </div>
        <div class="card" style="box-shadow:none">
          <div style="font-weight:900">Key flags & notes</div>
          <div class="tiny">These affect interpretation. Included in clinician summary.</div>
          <div id="flagsBox" style="margin-top:10px;"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div>
        <div style="font-weight:900">All conditions (screening index)</div>
        <div class="tiny">Everything is listed with a match %. Most will be low, which is normal.</div>
        <table class="table" id="allMatchesTable"></table>
      </div>

      <div class="hr"></div>
      <div>
        <div style="font-weight:900">Clinician summary (EHR-style)</div>
        <div class="tiny">Neutral language, “screening only,” includes rule-outs and timeline cues.</div>
        <pre id="ehrSummary"></pre>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   OPTION A — FINISHED (Single-file)
   - 100+ questions (gated)
   - Deterministic scoring (no randomness)
   - Rule-outs dampen results
   - Save/resume + progress bar
   - Full-page results + EHR-style summary
   - Educational screening only (NOT diagnosis)
========================================================= */

/* -----------------------------
   SCALES
----------------------------- */
const FREQ_OPTS = ["Never","Sometimes","Often","Almost always"]; // 0..3
const YESNO_OPTS = ["No","Yes"]; // 0..1

const SCALE_POINTS = {
  freq: { "Never":0, "Sometimes":1, "Often":2, "Almost always":3 },
  yesno: { "No":0, "Yes":3 } // treat "Yes" as strong signal for gates/ruleouts
};

function pts(scale, ans){
  if(!ans) return 0;
  return (SCALE_POINTS[scale] && SCALE_POINTS[scale][ans] != null) ? SCALE_POINTS[scale][ans] : 0;
}
function isPositive(scale, ans){
  if(!ans) return false;
  if(scale === "yesno") return ans === "Yes";
  return ans !== "Never";
}

/* -----------------------------
   MODE
----------------------------- */
let MODE = "adult"; // adult | child

/* -----------------------------
   CORE GATES
   Unlock sections based on positive answers.
----------------------------- */
const CORE_GATES = [
  {id:"gate_mood_low", text:"Over the past few weeks, have you often felt down, empty, or hopeless?", scale:"freq", unlock:["mood","depressive"]},
  {id:"gate_loss_interest", text:"Have you lost interest or joy in things you normally enjoy?", scale:"freq", unlock:["mood","depressive"]},
  {id:"gate_mood_high", text:"Have you had periods where you felt unusually energized, driven, or irritable compared to your usual self?", scale:"freq", unlock:["bipolar","mood"]},
  {id:"gate_anxiety", text:"Do you often feel anxious, tense, on edge, or unable to relax?", scale:"freq", unlock:["anxiety"]},
  {id:"gate_panic", text:"Have you had sudden surges of fear/discomfort that peaked quickly (panic-like episodes)?", scale:"freq", unlock:["panic","anxiety"]},
  {id:"gate_obsessions", text:"Do intrusive thoughts/urges show up that feel hard to control (even if you know they don’t make sense)?", scale:"freq", unlock:["ocd"]},
  {id:"gate_trauma", text:"Have you experienced or witnessed something traumatic, overwhelming, or life-threatening?", scale:"yesno", unlock:["trauma","dissociation"]},
  {id:"gate_dissociation", text:"Have you felt detached from yourself or your surroundings, like things don’t feel real?", scale:"freq", unlock:["dissociation","trauma"]},
  {id:"gate_psychosis", text:"Have you experienced perceptions others couldn’t verify (voices/visions) or beliefs others found implausible?", scale:"freq", unlock:["psychosis"]},
  {id:"gate_attention", text:"Have you had long-standing difficulty with attention, organization, or completing tasks?", scale:"freq", unlock:["neurodev"]},
  {id:"gate_childhood_onset", text:"Did those attention/behavior difficulties begin in childhood (before your mid-teens)?", scale:"yesno", unlock:["neurodev"]},
  {id:"gate_eating", text:"Have eating, weight, or body image concerns significantly affected your life?", scale:"freq", unlock:["eating"]},
  {id:"gate_sleep_primary", text:"Is sleep itself one of your main concerns (not only a side-effect of stress/mood)?", scale:"yesno", unlock:["sleep"]},
  {id:"gate_substances", text:"Have alcohol, medications, or other substances caused problems in your life?", scale:"freq", unlock:["substance"]},
  {id:"gate_cognition", text:"Have you noticed problems with memory/thinking/mental clarity beyond normal stress or aging?", scale:"freq", unlock:["neurocog"]},
  {id:"gate_relationships", text:"Have your relationships been intense, unstable, or difficult to maintain over time?", scale:"freq", unlock:["personality"]},
  {id:"gate_identity", text:"Do you struggle with a stable sense of who you are or what you want long-term?", scale:"freq", unlock:["personality","dissociation"]},
  {id:"gate_behavior_control", text:"Have you had repeated difficulty controlling anger, aggression, or rule-breaking behavior?", scale:"freq", unlock:["disruptive","personality"]},
  {id:"gate_sexual_distress", text:"Have sexual concerns or distress significantly affected your wellbeing or relationships?", scale:"freq", unlock:["sexual"]},
  {id:"gate_gender_distress", text:"Have you felt persistent distress or discomfort related to your gender experience or body?", scale:"freq", unlock:["gender"]},
  {id:"gate_paraphilic_distress", text:"Do sexual interests/behaviors cause distress, impairment, or risk of harm to others?", scale:"freq", unlock:["paraphilic"]}
];

/* -----------------------------
   RULE-OUTS / CONFOUNDS
   Dampens confidence if "Yes".
----------------------------- */
const CONFOUNDS = [
  {id:"c_medical", scale:"yesno", text:"Could a medical condition (thyroid, neurological, sleep apnea, etc.) plausibly explain some symptoms?"},
  {id:"c_meds", scale:"yesno", text:"Did symptoms start or worsen soon after starting/changing a medication?"},
  {id:"c_substances_now", scale:"yesno", text:"Do symptoms mostly happen during intoxication, withdrawal, or heavy/hectic use periods?"},
  {id:"c_sleep_deprivation", scale:"yesno", text:"Have symptoms been strongly driven by sleep deprivation, shift work, or major sleep disruption?"},
  {id:"c_acute_grief", scale:"yesno", text:"Are symptoms primarily tied to recent bereavement/grief (past few months)?"}
];

/* -----------------------------
   SHARED QUESTION BANK (100+)
   Each question contributes to one or more domains.
   This is NOT DSM criterion text; it's human-friendly screening phrasing.
----------------------------- */
const DOMAIN_SECTIONS = [
  {
    id:"sec_mood", title:"Mood (Depression & Bipolar Patterns)", unlockAny:["mood","depressive","bipolar"],
    questions: [
      {id:"mood1", scale:"freq", domains:{dep:1}, text:"Have things you normally enjoy felt less interesting or meaningful?"},
      {id:"mood2", scale:"freq", domains:{dep:1}, text:"Have you felt sad, empty, or numb more days than not?"},
      {id:"mood3", scale:"freq", domains:{dep:1}, text:"Have you felt unusually guilty, worthless, or like a burden?"},
      {id:"mood4", scale:"freq", domains:{dep:1}, text:"Have you had noticeably low energy or felt “dragged down” a lot?"},
      {id:"mood5", scale:"freq", domains:{dep:1}, text:"Has your appetite changed a lot (way less or way more) not just from diet choices?"},
      {id:"mood6", scale:"freq", domains:{dep:1}, text:"Has your sleep shifted a lot (too little or too much) tied to mood?"},
      {id:"mood7", scale:"freq", domains:{dep:1}, text:"Have you had trouble concentrating because your mood is heavy or foggy?"},
      {id:"mood8", scale:"freq", domains:{dep:1}, text:"Have you felt hopeless about the future?"},
      {id:"mood9", scale:"freq", domains:{safety:1, dep:1}, flag:"safety", text:"Have you had thoughts that life isn’t worth it, or thoughts of self-harm?"},
      {id:"mania1", scale:"freq", domains:{mania:1}, text:"Have you needed much less sleep and still felt energized (not tired)?", help:"Not insomnia where you feel awful. More like: 3–4 hours and still wired/okay."},
      {id:"mania2", scale:"freq", domains:{mania:1}, text:"Have you felt unusually confident, unstoppable, or “bigger than life”?"},
      {id:"mania3", scale:"freq", domains:{mania:1}, text:"Have your thoughts raced or jumped topic-to-topic more than usual?"},
      {id:"mania4", scale:"freq", domains:{mania:1}, text:"Have you talked much more than usual or felt pressure to keep talking?"},
      {id:"mania5", scale:"freq", domains:{mania:1}, text:"Have you been unusually goal-driven or restless, like you couldn’t slow down?"},
      {id:"mania6", scale:"freq", domains:{mania:1, risk:1}, text:"During high-energy periods, have you made risky choices (money, sex, substances, reckless driving)?"},
      {id:"mania7", scale:"freq", domains:{mania:1}, text:"Have others said you seemed unusually intense, irritable, or “not yourself”?"},
      {id:"mania8", scale:"freq", domains:{mania:1}, text:"Have these high-energy periods caused real problems (work, relationships, legal, financial)?"}
    ]
  },
  {
    id:"sec_anxiety", title:"Anxiety & Panic", unlockAny:["anxiety","panic"],
    questions: [
      {id:"anx1", scale:"freq", domains:{anx:1}, text:"Do you worry so much it feels hard to control?"},
      {id:"anx2", scale:"freq", domains:{anx:1}, text:"Does worry show up most days (even when things are “fine”)?"},
      {id:"anx3", scale:"freq", domains:{anx:1}, text:"Do you get muscle tension, restlessness, stomach upset, or shakiness from anxiety?"},
      {id:"anx4", scale:"freq", domains:{anx:1}, text:"Does anxiety interfere with sleep, focus, or relationships?"},
      {id:"panic1", scale:"freq", domains:{panic:1}, text:"Do you get sudden waves of fear with physical symptoms (heart racing, shaking, shortness of breath)?"},
      {id:"panic2", scale:"freq", domains:{panic:1}, text:"After a panic episode, do you worry about having another one?"},
      {id:"panic3", scale:"freq", domains:{panic:1}, text:"Do you avoid situations because you fear panicking or losing control in public?"},
      {id:"soc1", scale:"freq", domains:{soc:1, anx:1}, text:"Do you avoid social situations because you fear judgment or embarrassment?"},
      {id:"soc2", scale:"freq", domains:{soc:1}, text:"Do you replay social interactions afterward and criticize yourself?"},
      {id:"ag1", scale:"freq", domains:{agor:1, panic:1}, text:"Do you avoid places where escaping or getting help feels hard (crowds, transit, lines)?"},
      {id:"ph1", scale:"freq", domains:{phobia:1, anx:1}, text:"Do you have a specific fear (needles, heights, flying, etc.) that feels disproportionate but still controls choices?"}
    ]
  },
  {
    id:"sec_ocd", title:"Obsessions / Compulsions & Related", unlockAny:["ocd"],
    questions: [
      {id:"ocd1", scale:"freq", domains:{ocd:1}, text:"Do unwanted thoughts/images pop in and feel distressing or sticky?"},
      {id:"ocd2", scale:"freq", domains:{ocd:1}, text:"Do you do rituals (checking, washing, counting, repeating) to reduce anxiety?"},
      {id:"ocd3", scale:"freq", domains:{ocd:1}, text:"Do these rituals or mental loops steal a lot of time/energy?"},
      {id:"bdd1", scale:"freq", domains:{bdd:1}, text:"Do you feel distress about perceived flaws in appearance that others don’t see the same way?"},
      {id:"bdd2", scale:"freq", domains:{bdd:1}, text:"Do you check mirrors, compare, hide, or avoid photos because of appearance distress?"},
      {id:"hoard1", scale:"freq", domains:{hoard:1}, text:"Do you struggle to discard items even when they have little value?"},
      {id:"hoard2", scale:"freq", domains:{hoard:1}, text:"Has clutter interfered with living spaces (walking paths, rooms unusable)?"},
      {id:"trich1", scale:"freq", domains:{trich:1}, text:"Do you pull hair (scalp, brows, lashes) and struggle to stop?"},
      {id:"skin1", scale:"freq", domains:{skin:1}, text:"Do you pick at skin (scabs, blemishes) in a way that causes damage and is hard to stop?"}
    ]
  },
  {
    id:"sec_trauma", title:"Trauma & Stressor-Related", unlockAny:["trauma","dissociation"],
    questions: [
      {id:"ptsd1", scale:"freq", domains:{ptsd:1}, text:"Do unwanted memories, flashbacks, or nightmares intrude about a traumatic experience?"},
      {id:"ptsd2", scale:"freq", domains:{ptsd:1}, text:"Do you avoid reminders (places, people, topics, feelings) linked to trauma?"},
      {id:"ptsd3", scale:"freq", domains:{ptsd:1}, text:"Do you feel constantly on guard, easily startled, or unable to fully relax?"},
      {id:"ptsd4", scale:"freq", domains:{ptsd:1}, text:"Do you feel emotionally numb or detached from others since the trauma?"},
      {id:"as1", scale:"freq", domains:{adjust:1}, text:"Did symptoms start after a major life change/stressor (breakup, job loss, move) and feel out of proportion?"},
      {id:"as2", scale:"freq", domains:{adjust:1}, text:"Have stress symptoms (sad/anxious/behavior changes) impaired daily life after a stressor?"},
      {id:"asd1", scale:"freq", domains:{asd:1}, text:"In the month after trauma, did you have intense intrusion/avoidance/arousal symptoms?"},
      {id:"diss1", scale:"freq", domains:{diss:1}, text:"Do you feel detached from yourself (like watching yourself) or the world feels unreal?"},
      {id:"diss2", scale:"freq", domains:{diss:1}, text:"Do you have memory gaps for stressful events or chunks of time you can’t account for?"}
    ]
  },
  {
    id:"sec_psych", title:"Reality Testing / Psychosis-Like Experiences", unlockAny:["psychosis"],
    questions: [
      {id:"psy1", scale:"freq", domains:{psych:1}, text:"Do you hear voices/sounds others don’t (when not half-asleep)?"},
      {id:"psy2", scale:"freq", domains:{psych:1}, text:"Do you see things others don’t, or strongly sense a presence?"},
      {id:"psy3", scale:"freq", domains:{psych:1}, text:"Do you hold strong beliefs others say are implausible and you couldn’t doubt them?"},
      {id:"psy4", scale:"freq", domains:{psych:1}, text:"Have others said your speech/thinking was hard to follow (jumping, tangential)?"},
      {id:"psy5", scale:"freq", domains:{neg:1}, text:"Have you felt emotionally flat, socially withdrawn, or less expressive than before?"},
      {id:"psy6", scale:"freq", domains:{disorg:1}, text:"Do daily tasks feel harder because of disorganization/confusion unrelated to attention issues?"}
    ]
  },
  {
    id:"sec_neurodev", title:"Attention / Neurodevelopmental", unlockAny:["neurodev"],
    questions: [
      {id:"adhd1", scale:"freq", domains:{adhd:1, exec:1}, text:"Do you struggle to sustain focus even on important tasks?"},
      {id:"adhd2", scale:"freq", domains:{adhd:1, exec:1}, text:"Do you forget deadlines, lose things, or start tasks but don’t finish?"},
      {id:"adhd3", scale:"freq", domains:{adhd:1}, text:"Do you feel restless or need stimulation to stay engaged?"},
      {id:"adhd4", scale:"freq", domains:{adhd:1}, text:"Do you interrupt, blurt, or act before thinking and regret it later?"},
      {id:"asd1a", scale:"freq", domains:{asd:1}, text:"Do you find social cues, implied meaning, or “reading the room” hard?"},
      {id:"asd2a", scale:"freq", domains:{asd:1}, text:"Do you strongly prefer routine and feel distressed by unexpected changes?"},
      {id:"asd3a", scale:"freq", domains:{asd:1}, text:"Do you have intense, narrow interests that absorb your attention deeply?"},
      {id:"tic1", scale:"freq", domains:{tic:1}, text:"Do you have repeated involuntary movements or sounds (tics) that you can’t fully control?"}
    ]
  },
  {
    id:"sec_personality", title:"Long-Term Personality Patterns", unlockAny:["personality"],
    questions: [
      {id:"pda1", scale:"freq", domains:{pdA:1}, text:"Do you often suspect others have hidden motives or might harm/cheat you?"},
      {id:"pda2", scale:"freq", domains:{pdA:1}, text:"Do you feel emotionally detached, preferring isolation over closeness?"},
      {id:"pda3", scale:"freq", domains:{pdA:1}, text:"Do you feel “different” in a way that makes you seem odd, eccentric, or out of sync socially?"},
      {id:"pdb1", scale:"freq", domains:{pdB:1}, text:"Do you fear abandonment or do extreme things to avoid being left?"},
      {id:"pdb2", scale:"freq", domains:{pdB:1}, text:"Do your relationships swing between idealizing someone and then feeling intense anger/disappointment?"},
      {id:"pdb3", scale:"freq", domains:{pdB:1}, text:"Do you feel chronic emptiness or unstable self-image that shifts a lot?"},
      {id:"pdb4", scale:"freq", domains:{pdB:1, risk:1}, text:"Do you act impulsively in ways that cause harm (spending, sex, substances, fights)?"},
      {id:"pdc1", scale:"freq", domains:{pdC:1}, text:"Do you avoid opportunities because you fear rejection, criticism, or feeling inadequate?"},
      {id:"pdc2", scale:"freq", domains:{pdC:1}, text:"Do you struggle to make decisions without reassurance or support?"},
      {id:"pdc3", scale:"freq", domains:{pdC:1}, text:"Do you get stuck in perfectionism or rigid standards that slow you down or strain relationships?"}
    ]
  },
  {
    id:"sec_disruptive", title:"Anger / Impulse-Control / Conduct", unlockAny:["disruptive"],
    questions: [
      {id:"ied1", scale:"freq", domains:{ied:1, anger:1}, text:"Do you have sudden anger outbursts that feel bigger than the situation?"},
      {id:"ied2", scale:"freq", domains:{ied:1, anger:1}, text:"Have outbursts caused problems (relationships, work, legal trouble)?"},
      {id:"cd1", scale:"freq", domains:{conduct:1}, text:"For youth: repeated rule-breaking, lying, theft, cruelty, or serious aggression?"},
      {id:"odd1", scale:"freq", domains:{odd:1}, text:"For youth: frequent arguing with adults, defiance, spitefulness, or losing temper?"}
    ],
    onlyMode: "child_or_adult"
  },
  {
    id:"sec_somatic", title:"Somatic Symptom Focus", unlockAny:["somatic","mood","anxiety"],
    questions: [
      {id:"som1", scale:"freq", domains:{som:1}, text:"Do you spend lots of time worrying about symptoms or scanning your body for problems?"},
      {id:"som2", scale:"freq", domains:{som:1}, text:"Do health worries persist even after reassurance or normal test results?"},
      {id:"som3", scale:"freq", domains:{som:1}, text:"Do symptoms cause major distress or interfere with life even when causes are unclear?"},
      {id:"fnd1", scale:"freq", domains:{fnd:1}, text:"Have you had neurological-like symptoms (weakness, seizures, sensory loss) without a clear medical explanation?"}
    ]
  },
  {
    id:"sec_eating", title:"Eating / Body Image", unlockAny:["eating"],
    questions: [
      {id:"eat1", scale:"freq", domains:{an:1, body:1}, text:"Do you fear weight gain intensely or feel driven to be thinner despite risks?"},
      {id:"eat2", scale:"freq", domains:{an:1}, text:"Do you restrict food in a way that affects energy, health, or functioning?"},
      {id:"eat3", scale:"freq", domains:{bn:1}, text:"Do you have episodes of eating a lot quickly with loss of control?"},
      {id:"eat4", scale:"freq", domains:{bn:1}, text:"Do you compensate afterward (vomiting, laxatives, fasting, excessive exercise)?"},
      {id:"eat5", scale:"freq", domains:{bed:1}, text:"Do binge episodes happen without compensating, but with distress/guilt?"},
      {id:"arfid1", scale:"freq", domains:{arfid:1}, text:"Do you avoid foods due to texture/smell/fear of choking and it impacts nutrition/health?"}
    ]
  },
  {
    id:"sec_sleep", title:"Sleep-Wake", unlockAny:["sleep","mood","anxiety"],
    questions: [
      {id:"ins1", scale:"freq", domains:{insomnia:1}, text:"Do you struggle to fall asleep, stay asleep, or wake too early (and it bothers you)?"},
      {id:"ins2", scale:"freq", domains:{insomnia:1}, text:"Does poor sleep significantly affect daytime energy, mood, or functioning?"},
      {id:"hyp1", scale:"freq", domains:{hypersom:1}, text:"Do you sleep a lot or feel sleepy during the day despite enough time in bed?"},
      {id:"night1", scale:"freq", domains:{nightmare:1}, text:"Do you have frequent nightmares that disrupt sleep or cause distress?"},
      {id:"circ1", scale:"freq", domains:{circadian:1}, text:"Is your sleep schedule chronically misaligned (late sleep, shift-like patterns) and hard to fix?"}
    ]
  },
  {
    id:"sec_substance", title:"Substance / Addictive Patterns", unlockAny:["substance"],
    questions: [
      {id:"sub1", scale:"freq", domains:{sud:1}, text:"Have you used more than intended or found it hard to cut down?"},
      {id:"sub2", scale:"freq", domains:{sud:1}, text:"Has use caused problems at work/school/home or in relationships?"},
      {id:"sub3", scale:"freq", domains:{sud:1}, text:"Do you continue despite knowing it worsens mood/anxiety/health?"},
      {id:"sub4", scale:"freq", domains:{sud:1}, text:"Do you spend a lot of time obtaining/using/recovering from substances?"},
      {id:"gam1", scale:"freq", domains:{gambling:1}, text:"Have gambling behaviors caused significant distress, financial harm, or relationship conflict?"}
    ]
  },
  {
    id:"sec_neurocog", title:"Memory / Thinking (Neurocognitive Screening)", unlockAny:["neurocog"],
    questions: [
      {id:"cog1", scale:"freq", domains:{ncd:1}, text:"Have you noticed persistent memory problems (forgetting recent events, repeating questions)?"},
      {id:"cog2", scale:"freq", domains:{ncd:1}, text:"Do you struggle with planning, problem-solving, or mental “clarity” more than before?"},
      {id:"cog3", scale:"freq", domains:{ncd:1}, text:"Have these changes interfered with independence (finances, meds, appointments, safety)?"}
    ]
  },
  {
    id:"sec_sexual", title:"Sexual & Gender Distress (Screening)", unlockAny:["sexual","gender","paraphilic"],
    questions: [
      {id:"sex1", scale:"freq", domains:{sex:1}, text:"Do sexual concerns cause significant distress or relationship strain?"},
      {id:"sex2", scale:"freq", domains:{sex:1}, text:"Has desire/arousal or orgasm difficulty been persistent and distressing?"},
      {id:"gd1", scale:"freq", domains:{gd:1}, text:"Do you feel persistent distress around your body/role not matching your gender experience?"},
      {id:"para1", scale:"freq", domains:{para:1}, text:"Do sexual interests/behaviors cause distress, impairment, or risk of harm to others?"}
    ]
  }
];

/* -----------------------------
   DISORDER INDEX + SCORING MAP
   Deterministic: weights by domains + required gates (confidence penalty if missing).
   This is a screening map, not diagnostic criteria.
----------------------------- */
const DISORDERS = [
  // Depressive
  {id:"mdd", name:"Major Depressive Disorder", chapter:"Depressive", requireAny:["gate_mood_low","gate_loss_interest"], weights:{dep:1.0}, notes:["Consider duration, impairment, and medical/substance rule-outs."]},
  {id:"pdd", name:"Persistent Depressive Disorder (Dysthymia)", chapter:"Depressive", requireAny:["gate_mood_low"], weights:{dep:0.8, insomnia:0.2}, notes:["Typically long-duration pattern; clinician confirms timeline."]},
  // Bipolar
  {id:"bp1", name:"Bipolar I Disorder (mania pattern)", chapter:"Bipolar", requireAny:["gate_mood_high"], weights:{mania:1.0, risk:0.3}, notes:["Manic episodes require clinical assessment; rule out substances/medical."]},
  {id:"bp2", name:"Bipolar II Disorder (hypomania + depression pattern)", chapter:"Bipolar", requireAny:["gate_mood_high","gate_mood_low"], weights:{mania:0.7, dep:0.7}, notes:["Screening only; clinician confirms episode history and duration."]},

  // Anxiety
  {id:"gad", name:"Generalized Anxiety Disorder", chapter:"Anxiety", requireAny:["gate_anxiety"], weights:{anx:1.0}, notes:["Consider duration and medical contributors (thyroid, stimulants, etc.)."]},
  {id:"panic", name:"Panic Disorder", chapter:"Anxiety", requireAny:["gate_panic"], weights:{panic:1.0, agor:0.3}, notes:["Rule out substances, hyperthyroid, cardiac issues."]},
  {id:"soc", name:"Social Anxiety Disorder", chapter:"Anxiety", requireAny:["gate_anxiety"], weights:{soc:1.0}, notes:["Screening match; clinician assesses severity/avoidance."]},
  {id:"agor", name:"Agoraphobia (screening)", chapter:"Anxiety", requireAny:["gate_panic","gate_anxiety"], weights:{agor:1.0, panic:0.4}, notes:["Often overlaps with panic; clinician confirms pattern."]},
  {id:"phobia", name:"Specific Phobia (screening)", chapter:"Anxiety", requireAny:["gate_anxiety"], weights:{phobia:1.0}, notes:["Specific trigger-based avoidance."]},

  // OCD-related
  {id:"ocd", name:"Obsessive-Compulsive Disorder", chapter:"OCD-related", requireAny:["gate_obsessions"], weights:{ocd:1.0}, notes:["Time-consuming rituals/obsessions drive match."]},
  {id:"bdd", name:"Body Dysmorphic Disorder (screening)", chapter:"OCD-related", requireAny:["gate_obsessions"], weights:{bdd:1.0}, notes:["Distress + checking/avoidance."]},
  {id:"hoard", name:"Hoarding Disorder (screening)", chapter:"OCD-related", requireAny:["gate_obsessions"], weights:{hoard:1.0}, notes:["Clinician confirms clutter + difficulty discarding."]},
  {id:"trich", name:"Trichotillomania (screening)", chapter:"OCD-related", requireAny:["gate_obsessions"], weights:{trich:1.0}, notes:["Hair-pulling with impairment/distress."]},
  {id:"skin", name:"Excoriation (Skin-Picking) Disorder (screening)", chapter:"OCD-related", requireAny:["gate_obsessions"], weights:{skin:1.0}, notes:["Skin picking with impairment/distress."]},

  // Trauma
  {id:"ptsd", name:"Posttraumatic Stress Disorder", chapter:"Trauma", requireAny:["gate_trauma"], weights:{ptsd:1.0}, notes:["Clinician confirms trauma criteria, duration, and symptom clusters."]},
  {id:"asd", name:"Acute Stress Disorder (screening)", chapter:"Trauma", requireAny:["gate_trauma"], weights:{asd:1.0}, notes:["Time-limited after trauma; clinician confirms timing."]},
  {id:"adjust", name:"Adjustment Disorder (screening)", chapter:"Trauma", requireAny:["gate_anxiety","gate_mood_low"], weights:{adjust:1.0, anx:0.3, dep:0.3}, notes:["Linked to identifiable stressor; clinician confirms."]},

  // Dissociation
  {id:"diss", name:"Depersonalization/Derealization or Dissociative Pattern (screening)", chapter:"Dissociative", requireAny:["gate_dissociation"], weights:{diss:1.0}, notes:["Clinician differentiates dissociative disorders and trauma effects."]},

  // Psychosis spectrum (screening)
  {id:"psychosis", name:"Psychosis Spectrum (screening)", chapter:"Psychotic", requireAny:["gate_psychosis"], weights:{psych:1.0, disorg:0.4, neg:0.3}, notes:["High-stakes area: clinician assessment required. Rule out substances/medical."]},

  // Neurodevelopmental
  {id:"adhd", name:"ADHD (screening)", chapter:"Neurodevelopmental", requireAny:["gate_attention","gate_childhood_onset"], weights:{adhd:1.0, exec:0.5}, notes:["Clinician confirms childhood onset, settings, impairment."]},
  {id:"asd_s", name:"Autism Spectrum Traits (screening)", chapter:"Neurodevelopmental", requireAny:["gate_attention"], weights:{asd:1.0}, notes:["Not diagnostic; clinician evaluates developmental history."]},
  {id:"tic", name:"Tic Disorder Pattern (screening)", chapter:"Neurodevelopmental", requireAny:["gate_attention"], weights:{tic:1.0}, notes:["Clinician confirms type and duration."]},

  // Personality (screening buckets + common PD patterns)
  {id:"pdA", name:"Personality Pattern A (odd/eccentric) — screening", chapter:"Personality", requireAny:["gate_relationships"], weights:{pdA:1.0}, notes:["Includes paranoid/schizoid/schizotypal traits. Clinician differentiates."]},
  {id:"pdB", name:"Personality Pattern B (dramatic/unstable) — screening", chapter:"Personality", requireAny:["gate_relationships","gate_identity"], weights:{pdB:1.0, risk:0.4}, notes:["Includes borderline/histrionic/narcissistic/antisocial traits. Clinician differentiates."]},
  {id:"pdC", name:"Personality Pattern C (anxious/fearful) — screening", chapter:"Personality", requireAny:["gate_relationships"], weights:{pdC:1.0}, notes:["Includes avoidant/dependent/OCPD traits. Clinician differentiates."]},

  // Disruptive/Impulse
  {id:"ied", name:"Intermittent Explosive Disorder (screening)", chapter:"Disruptive/Impulse", requireAny:["gate_behavior_control"], weights:{ied:1.0, anger:0.7}, notes:["Clinician confirms frequency, disproportionality, rule-outs."]},

  // Somatic
  {id:"som", name:"Somatic Symptom Disorder (screening)", chapter:"Somatic", requireAny:["gate_somatic","gate_anxiety","gate_mood_low"], weights:{som:1.0}, notes:["Clinician rules out medical causes and evaluates focus/distress."]},
  {id:"fnd", name:"Functional Neurological Symptom Pattern (screening)", chapter:"Somatic", requireAny:["gate_somatic"], weights:{fnd:1.0}, notes:["Requires medical/neurological evaluation."]},

  // Eating
  {id:"an", name:"Anorexia Nervosa Pattern (screening)", chapter:"Feeding/Eating", requireAny:["gate_eating"], weights:{an:1.0, body:0.5}, notes:["High medical risk. Clinician assessment required."]},
  {id:"bn", name:"Bulimia Nervosa Pattern (screening)", chapter:"Feeding/Eating", requireAny:["gate_eating"], weights:{bn:1.0}, notes:["Clinician confirms frequency and compensatory behaviors."]},
  {id:"bed", name:"Binge-Eating Disorder Pattern (screening)", chapter:"Feeding/Eating", requireAny:["gate_eating"], weights:{bed:1.0}, notes:["Clinician confirms pattern + distress."]},
  {id:"arfid", name:"ARFID Pattern (screening)", chapter:"Feeding/Eating", requireAny:["gate_eating"], weights:{arfid:1.0}, notes:["Often sensory/fear-based; clinician confirms."]},

  // Sleep
  {id:"ins", name:"Insomnia Disorder Pattern (screening)", chapter:"Sleep-Wake", requireAny:["gate_sleep_primary"], weights:{insomnia:1.0}, notes:["Clinician confirms duration and rule-outs (sleep apnea, substances, etc.)."]},
  {id:"hyp", name:"Hypersomnolence Pattern (screening)", chapter:"Sleep-Wake", requireAny:["gate_sleep_primary"], weights:{hypersom:1.0}, notes:["Clinician rules out medical and sleep disorders."]},
  {id:"circ", name:"Circadian Rhythm Sleep-Wake Pattern (screening)", chapter:"Sleep-Wake", requireAny:["gate_sleep_primary"], weights:{circadian:1.0}, notes:["Chronically shifted schedule; clinician confirms."]},
  {id:"night", name:"Nightmare Disorder Pattern (screening)", chapter:"Sleep-Wake", requireAny:["gate_sleep_primary","gate_trauma"], weights:{nightmare:1.0, ptsd:0.3}, notes:["Nightmares may be trauma-linked; clinician differentiates."]},

  // Substance/Addictive
  {id:"sud", name:"Substance Use Disorder Pattern (screening)", chapter:"Substance/Addictive", requireAny:["gate_substances"], weights:{sud:1.0}, notes:["Not substance-specific; clinician evaluates substance and severity."]},
  {id:"gamb", name:"Gambling Disorder Pattern (screening)", chapter:"Substance/Addictive", requireAny:["gate_substances"], weights:{gambling:1.0}, notes:["Clinician confirms impairment/distress and frequency."]},

  // Neurocognitive
  {id:"ncd", name:"Neurocognitive Disorder Pattern (screening)", chapter:"Neurocognitive", requireAny:["gate_cognition"], weights:{ncd:1.0}, notes:["Medical evaluation required to confirm cause."]},

  // Sexual/Gender/Paraphilic (screening)
  {id:"sex", name:"Sexual Dysfunction / Sexual Distress (screening)", chapter:"Sexual", requireAny:["gate_sexual_distress"], weights:{sex:1.0}, notes:["Clinician confirms duration and distress/impairment."]},
  {id:"gd", name:"Gender Dysphoria (screening)", chapter:"Gender", requireAny:["gate_gender_distress"], weights:{gd:1.0}, notes:["Clinician assessment focuses on distress, persistence, context."]},
  {id:"para", name:"Paraphilic Disorder Distress/Risk Pattern (screening)", chapter:"Paraphilic", requireAny:["gate_paraphilic_distress"], weights:{para:1.0}, notes:["Clinician evaluates consent, harm-risk, distress/impairment."]}
];

/* -----------------------------
   ANSWERS STATE
----------------------------- */
const answers = {};          // questionId -> option string
const demographics = { name:"", age:"", sex:"", gender:"", orientation:"", race:"", therapy:"", diagnosed:"", diagnosis:"", acknowledge:false };
const visibleQIds = new Set(); // for progress calc

/* -----------------------------
   UI HELPERS
----------------------------- */
function optButtons(container, qid, scale, options){
  const row = document.createElement("div");
  row.className = "opts";
  options.forEach(opt=>{
    const b = document.createElement("div");
    b.className = "opt";
    b.textContent = opt;
    b.onclick = ()=>{
      answers[qid] = opt;
      [...row.querySelectorAll(".opt")].forEach(x=>x.classList.remove("sel"));
      b.classList.add("sel");
      scheduleAutosave();
      refreshAll();
    };
    row.appendChild(b);
  });
  container.appendChild(row);
}

function demoValue(key){
  return String(demographics[key] || "").trim();
}
function demoValueOrDash(key){
  const v = demoValue(key);
  return v ? v : "—";
}
function selectDemOption(elem, fieldId, value){
  demographics[fieldId.replace('dem_','')] = value;
  const parent = elem.parentElement;
  [...parent.querySelectorAll(".opt")].forEach(x=>x.classList.remove("sel"));
  elem.classList.add("sel");
  scheduleAutosave();
}
function renderDemographicsInputs(){
  const map = [
    ["dem_name","name"],
    ["dem_age","age"],
    ["dem_sex","sex"],
    ["dem_gender","gender"],
    ["dem_orientation","orientation"],
    ["dem_race","race"],
    ["dem_diagnosis","diagnosis"]
  ];
  map.forEach(([id, key])=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.value = demographics[key] || "";
  });
  // Restore button selections for therapy and diagnosed
  const therapyVal = demographics.therapy;
  if(therapyVal){
    document.querySelectorAll('#sec_demographics .opts').forEach((opts, idx)=>{
      if(idx === 0){ // therapy question
        [...opts.querySelectorAll('.opt')].forEach(o=>{
          if(o.textContent === therapyVal) o.classList.add('sel');
        });
      }
    });
  }
  const diagnosedVal = demographics.diagnosed;
  if(diagnosedVal){
    document.querySelectorAll('#sec_demographics .opts').forEach((opts, idx)=>{
      if(idx === 1){ // diagnosed question
        [...opts.querySelectorAll('.opt')].forEach(o=>{
          if(o.textContent === diagnosedVal) o.classList.add('sel');
        });
      }
    });
  }
  // Restore checkbox
  const ackEl = document.getElementById("dem_acknowledge");
  if(ackEl) ackEl.checked = demographics.acknowledge || false;
}
function bindDemographics(){
  const map = [
    ["dem_name","name"],
    ["dem_age","age"],
    ["dem_sex","sex"],
    ["dem_gender","gender"],
    ["dem_orientation","orientation"],
    ["dem_race","race"],
    ["dem_diagnosis","diagnosis"]
  ];
  map.forEach(([id, key])=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener("input", ()=>{
      demographics[key] = el.value;
      scheduleAutosave();
    });
  });
  // Bind checkbox
  const ackEl = document.getElementById("dem_acknowledge");
  if(ackEl){
    ackEl.addEventListener("change", ()=>{
      demographics.acknowledge = ackEl.checked;
      scheduleAutosave();
    });
  }
  renderDemographicsInputs();
}
function renderDemographicsSummary(){
  const wrap = document.getElementById("demographicsSummary");
  if(!wrap) return;
  wrap.innerHTML = "";
  const items = [
    ["Name", demoValue("name")],
    ["Age", demoValue("age")],
    ["Sex", demoValue("sex")],
    ["Gender identity", demoValue("gender")],
    ["Sexual orientation", demoValue("orientation")],
    ["Race", demoValue("race")],
    ["Prior therapy", demoValue("therapy")],
    ["Previously diagnosed", demoValue("diagnosed")],
    ["Prior diagnoses", demoValue("diagnosis")]
  ].filter(([, value])=>value);
  if(items.length === 0){
    const empty = document.createElement("div");
    empty.className = "tiny";
    empty.style.color = "var(--muted)";
    empty.textContent = "No demographic info provided.";
    wrap.appendChild(empty);
    return;
  }
  items.forEach(([label, value])=>{
    const pill = document.createElement("span");
    pill.className = "pill";
    pill.style.flex = "0 0 auto";
    const labelSpan = document.createElement("span");
    labelSpan.textContent = label + ": ";
    const valueSpan = document.createElement("b");
    valueSpan.textContent = value;
    pill.appendChild(labelSpan);
    pill.appendChild(valueSpan);
    wrap.appendChild(pill);
  });
}

function getUnlockedKeys(){
  const unlocked = new Set(["core","confounds"]);
  CORE_GATES.forEach(g=>{
    const a = answers[g.id];
    if(isPositive(g.scale, a)){
      (g.unlock||[]).forEach(k=>unlocked.add(k));
    }
  });
  // child mode can still show additional areas but we keep it simple
  return unlocked;
}

function countVisibleQuestions(){
  // visibleQIds is rebuilt during render
  const visCount = visibleQIds.size;
  let ansCount = 0;
  visibleQIds.forEach(id=>{
    if(answers[id]) ansCount++;
  });
  return {visCount, ansCount};
}

function updateProgress(){
  const {visCount, ansCount} = countVisibleQuestions();
  document.getElementById("visibleCount").textContent = String(visCount);
  document.getElementById("answeredCount").textContent = String(ansCount);
  const pct = visCount ? Math.round((ansCount/visCount)*100) : 0;
  document.getElementById("barFill").style.width = pct + "%";

  // visible sections count
  const unlocked = getUnlockedKeys();
  // Count domain sections that are actually unlocked
  const visibleSecs = DOMAIN_SECTIONS.filter(sec => sec.unlockAny.some(k=>unlocked.has(k)) && (!sec.onlyMode || sec.onlyMode==="child_or_adult" || (sec.onlyMode==="child" && MODE==="child") || (sec.onlyMode==="adult" && MODE==="adult")));
  document.getElementById("visSecCount").textContent = String(visibleSecs.length);
}

/* -----------------------------
   RENDER: MODE
----------------------------- */
function renderMode(){
  const el = document.getElementById("ageModeOpts");
  el.innerHTML = "";
  ["Adult","Child/Adolescent"].forEach(label=>{
    const v = label.startsWith("Adult") ? "adult" : "child";
    const b = document.createElement("div");
    b.className = "opt" + (MODE===v ? " sel" : "");
    b.textContent = label;
    b.onclick = ()=>{
      MODE = v;
      document.getElementById("modeLabel").textContent = (MODE==="adult" ? "Adult" : "Child/Adolescent");
      renderMode();
      scheduleAutosave();
      refreshAll();
    };
    el.appendChild(b);
  });
  document.getElementById("modeLabel").textContent = (MODE==="adult" ? "Adult" : "Child/Adolescent");
}

/* -----------------------------
   RENDER: CORE GATES
----------------------------- */
function renderCore(){
  const el = document.getElementById("coreQuestions");
  el.innerHTML = "";
  CORE_GATES.forEach(g=>{
    visibleQIds.add(g.id);
    const box = document.createElement("div");
    box.className = "q";
    box.innerHTML = `<div class="qtext">${g.text}</div>`;
    optButtons(box, g.id, g.scale, g.scale==="yesno" ? YESNO_OPTS : FREQ_OPTS);
    // restore selection
    const saved = answers[g.id];
    if(saved){
      [...box.querySelectorAll(".opt")].forEach(o=>{
        if(o.textContent===saved) o.classList.add("sel");
      });
    }
    el.appendChild(box);
  });
}

/* -----------------------------
   RENDER: CONFOUNDS
----------------------------- */
function renderConfounds(){
  const el = document.getElementById("confoundQuestions");
  el.innerHTML = "";
  CONFOUNDS.forEach(c=>{
    visibleQIds.add(c.id);
    const box = document.createElement("div");
    box.className = "q";
    box.innerHTML = `<div class="qtext">${c.text}</div>`;
    optButtons(box, c.id, c.scale, YESNO_OPTS);
    const saved = answers[c.id];
    if(saved){
      [...box.querySelectorAll(".opt")].forEach(o=>{
        if(o.textContent===saved) o.classList.add("sel");
      });
    }
    el.appendChild(box);
  });
}

/* -----------------------------
   RENDER: DOMAIN SECTIONS (gated)
----------------------------- */
function renderDomains(){
  const wrap = document.getElementById("domainSections");
  wrap.innerHTML = "";
  const unlocked = getUnlockedKeys();

  DOMAIN_SECTIONS.forEach(sec=>{
    if(!sec.unlockAny.some(k=>unlocked.has(k))) return;
    if(sec.onlyMode==="child" && MODE!=="child") return;
    if(sec.onlyMode==="adult" && MODE!=="adult") return;

    const card = document.createElement("div");
    card.className = "card";
    card.style.boxShadow = "none";
    card.innerHTML = `<div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h3>${sec.title}</h3>
        <div class="tiny">Answer what fits you best. Skipping leaves it neutral.</div>
      </div>
      <span class="badge">Gated</span>
    </div>`;

    sec.questions.forEach(q=>{
      visibleQIds.add(q.id);
      const box = document.createElement("div");
      box.className = "q";
      const help = q.help ? `<div class="qhelp">${q.help}</div>` : "";
      box.innerHTML = `<div class="qtext">${q.text}</div>${help}`;
      const options = (q.scale==="yesno") ? YESNO_OPTS : FREQ_OPTS;
      optButtons(box, q.id, q.scale, options);
      const saved = answers[q.id];
      if(saved){
        [...box.querySelectorAll(".opt")].forEach(o=>{
          if(o.textContent===saved) o.classList.add("sel");
        });
      }
      card.appendChild(box);
    });

    wrap.appendChild(card);
  });
}

/* -----------------------------
   SCORING ENGINE (deterministic)
   - Build domain totals from answered questions
   - Compute each disorder match as normalized weighted score
   - Apply confidence penalties:
     - missing required gates -> big dampener
     - confounds -> moderate dampeners
----------------------------- */
function computeDomainTotals(){
  const totals = {}; // domain -> raw points
  const maxes = {};  // domain -> max possible points (for visible answered questions only)

  // Walk all domain questions and accumulate based on answers
  DOMAIN_SECTIONS.forEach(sec=>{
    sec.questions.forEach(q=>{
      const a = answers[q.id];
      const p = pts(q.scale, a);

      // compute max for this question if it's visible (we track visibleQIds)
      const isVis = visibleQIds.has(q.id);
      if(!isVis) return;

      // per-domain contributions
      const dmap = q.domains || {};
      Object.keys(dmap).forEach(d=>{
        const w = dmap[d];
        totals[d] = (totals[d]||0) + p*w;
        // max points for freq is 3, yesno treated as 3
        const qMax = 3*w;
        maxes[d] = (maxes[d]||0) + qMax;
      });
    });
  });

  // normalize to 0..1 per domain (avoid divide-by-zero)
  const norm = {};
  Object.keys(totals).forEach(d=>{
    const m = maxes[d] || 0;
    norm[d] = m ? (totals[d]/m) : 0;
  });
  return {totals, maxes, norm};
}

function confoundPenalty(){
  // penalties are multiplicative dampeners
  // if confound yes, reduce confidence (not “score”) by a factor
  let damp = 1.0;
  const flags = [];

  const medical = answers["c_medical"]==="Yes";
  const meds = answers["c_meds"]==="Yes";
  const substances = answers["c_substances_now"]==="Yes";
  const sleep = answers["c_sleep_deprivation"]==="Yes";
  const grief = answers["c_acute_grief"]==="Yes";

  if(medical){ damp *= 0.78; flags.push("Medical causes may explain symptoms → confidence reduced."); }
  if(meds){ damp *= 0.82; flags.push("Medication timing may explain symptoms → confidence reduced."); }
  if(substances){ damp *= 0.72; flags.push("Symptoms linked to intoxication/withdrawal → confidence reduced (consider substance-induced)."); }
  if(sleep){ damp *= 0.84; flags.push("Sleep deprivation may drive symptoms → confidence reduced."); }
  if(grief){ damp *= 0.86; flags.push("Recent grief may explain mood symptoms → confidence reduced."); }

  return {damp, flags, confounds:{medical,meds,substances,sleep,grief}};
}

function gatePenalty(dis){
  // if none of required gates are positive, screening match gets heavily reduced
  const req = dis.requireAny || [];
  if(req.length===0) return {damp:1.0, note:null};
  const ok = req.some(gid=>{
    const gate = CORE_GATES.find(x=>x.id===gid);
    if(!gate) return false;
    return isPositive(gate.scale, answers[gid]);
  });
  if(ok) return {damp:1.0, note:null};
  return {damp:0.35, note:"Key gate not endorsed → low confidence."};
}

function computeMatches(){
  const {norm} = computeDomainTotals();
  const {damp:confDamp, flags:confFlags, confounds} = confoundPenalty();

  const matches = DISORDERS.map(dis=>{
    // weighted sum of normalized domains
    let raw = 0;
    let wsum = 0;
    Object.keys(dis.weights||{}).forEach(d=>{
      const w = dis.weights[d];
      raw += (norm[d]||0) * w;
      wsum += w;
    });
    const base = wsum ? (raw/wsum) : 0;

    // confidence dampeners
    const gp = gatePenalty(dis);
    let conf = base * confDamp * gp.damp;

    // high-stakes: psychosis patterns get extra conservative damp unless very strong
    if(dis.id==="psychosis" && base < 0.65) conf *= 0.75;

    // clamp and convert to percent
    let pct = Math.round(Math.max(0, Math.min(0.95, conf)) * 100);

    // add small calibration so scores aren't absurdly low with lots of "Sometimes"
    // (still deterministic): lift by 2% if any domain evidence exists
    const anyEvidence = Object.values(norm).some(v=>v>=0.20);
    if(anyEvidence) pct = Math.min(95, pct + 2);

    // build label class
    const cls = pct>=70 ? "high" : pct>=40 ? "med" : "low";

    // extra notes
    const notes = [];
    if(gp.note) notes.push(gp.note);
    if(confounds.substances && (dis.chapter==="Psychotic" || dis.chapter==="Bipolar" || dis.chapter==="Depressive")) notes.push("Consider substance/medication-induced possibilities.");
    if(confounds.medical && (dis.chapter==="Anxiety" || dis.chapter==="Depressive" || dis.chapter==="Bipolar")) notes.push("Consider medical contributors (thyroid, sleep disorders, etc.).");

    return {id:dis.id, name:dis.name, chapter:dis.chapter, pct, cls, notes, base:Math.round(base*100), confDamp, gateDamp:gp.damp};
  });

  // Sort descending by pct, stable by name
  matches.sort((a,b)=> (b.pct-a.pct) || a.name.localeCompare(b.name));
  return {matches, confFlags};
}

/* -----------------------------
   FLAGS + SAFETY
----------------------------- */
function buildFlags(){
  const flags = [];
  // safety
  const safetyQ = "mood9";
  if(isPositive("freq", answers[safetyQ])){
    flags.push({type:"danger", text:"Safety flag: endorsed self-harm thoughts. Encourage immediate clinical support if current/active."});
  }
  // psychosis gate
  if(isPositive("freq", answers["gate_psychosis"])){
    flags.push({type:"warn", text:"Reality-testing concern endorsed. If symptoms are current, clinician evaluation is strongly recommended."});
  }
  // substance confound
  if(answers["c_substances_now"]==="Yes"){
    flags.push({type:"warn", text:"Symptoms linked to intoxication/withdrawal endorsed. Substance-induced possibilities should be considered."});
  }
  // medical confound
  if(answers["c_medical"]==="Yes"){
    flags.push({type:"warn", text:"Medical explanation possible. Consider medical evaluation alongside mental health assessment."});
  }
  // sleep deprivation
  if(answers["c_sleep_deprivation"]==="Yes"){
    flags.push({type:"warn", text:"Sleep deprivation appears to drive symptoms. Address sleep as a first-line target."});
  }
  return flags;
}

/* -----------------------------
   EHR SUMMARY
----------------------------- */
function buildEHR(matches, confFlags){
  // Build a neutral, clinician-friendly summary using top items and key gates/confounds.
  const top = matches.slice(0,8);
  const endorsed = (id)=>answers[id] ? answers[id] : "—";
  const demoLines = [
    `- Name: ${demoValueOrDash("name")}`,
    `- Age: ${demoValueOrDash("age")}`,
    `- Sex: ${demoValueOrDash("sex")}`,
    `- Gender identity: ${demoValueOrDash("gender")}`,
    `- Sexual orientation: ${demoValueOrDash("orientation")}`,
    `- Race: ${demoValueOrDash("race")}`,
    `- Prior therapy: ${demoValueOrDash("therapy")}`,
    `- Previously diagnosed: ${demoValueOrDash("diagnosed")}`,
    `- Prior diagnoses: ${demoValueOrDash("diagnosis")}`
  ].join("\n");

  const gateLines = CORE_GATES.map(g=>{
    return `- ${g.text} => ${endorsed(g.id)}`;
  }).join("\n");

  const confLines = CONFOUNDS.map(c=>{
    return `- ${c.text} => ${endorsed(c.id)}`;
  }).join("\n");

  const topLines = top.map(m=>{
    const note = m.notes.length ? ` | Notes: ${m.notes.join(" ")}` : "";
    return `- ${m.name}: ${m.pct}% (screening match)${note}`;
  }).join("\n");

  const flags = buildFlags();
  const flagLines = flags.length ? flags.map(f=>`- ${f.text}`).join("\n") : "- None";

  const disclaimer = [
    "DISCLAIMER: Screening-only tool. Not a diagnosis. Requires clinical interview, timeline review, and rule-outs.",
    "Percentages represent pattern-alignment after confidence adjustments; they do not represent certainty."
  ].join("\n");

  return [
`SCREENING SUMMARY (Educational, Not Diagnostic)
Mode: ${MODE==="adult" ? "Adult" : "Child/Adolescent"}

PARTICIPANT INFO
${demoLines}

CORE GATES
${gateLines}

RULE-OUTS / CONFOUNDS
${confLines}

TOP SCREENING MATCHES
${topLines}

KEY FLAGS
${flagLines}

INTERPRETATION NOTES
- Confidence dampeners applied when medical/substance/sleep/grief explanations were endorsed.
- Areas requiring higher clinical scrutiny: psychosis spectrum, mania patterns, neurocognitive concerns.
${disclaimer}
`].join("\n");
}

/* -----------------------------
   RESULTS RENDER
----------------------------- */
function renderResults(){
  const {matches, confFlags} = computeMatches();
  const flags = buildFlags();
  renderDemographicsSummary();

  // Top matches table
  const topEl = document.getElementById("topMatchesTable");
  topEl.innerHTML = `<tr><th>Condition</th><th class="right">Match</th><th>Notes</th></tr>`;
  matches.slice(0,10).forEach(m=>{
    const notes = [...m.notes];
    if(m.pct>=70) notes.unshift("Strong screening alignment.");
    else if(m.pct>=40) notes.unshift("Moderate screening alignment.");
    else notes.unshift("Low screening alignment.");

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${m.name}<div class="tiny">${m.chapter}</div></td>
      <td class="right ${m.cls}">${m.pct}%</td>
      <td class="tiny">${notes.join(" ")}</td>`;
    topEl.appendChild(tr);
  });

  // Flags box
  const flagsBox = document.getElementById("flagsBox");
  if(flags.length===0 && confFlags.length===0){
    flagsBox.innerHTML = `<div class="tiny" style="color:var(--muted)">No major flags noted from rule-outs or safety items.</div>`;
  } else {
    const items = [];
    flags.forEach(f=>{
      const cls = f.type==="danger" ? "dangerbox" : "warnbox";
      items.push(`<div class="${cls}" style="margin-bottom:10px;"><b>${f.type==="danger"?"Safety":"Note"}:</b> ${f.text}</div>`);
    });
    if(confFlags.length){
      items.push(`<div class="warnbox"><b>Confidence adjustments:</b><ul style="margin:8px 0 0 18px;line-height:1.5">${confFlags.map(x=>`<li>${x}</li>`).join("")}</ul></div>`);
    }
    flagsBox.innerHTML = items.join("");
  }

  // All matches
  const allEl = document.getElementById("allMatchesTable");
  allEl.innerHTML = `<tr><th>Condition</th><th class="right">Match</th><th class="right">Base</th><th>Chapter</th></tr>`;
  matches.forEach(m=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${m.name}</td>
      <td class="right ${m.cls}">${m.pct}%</td>
      <td class="right tiny">${m.base}%</td>
      <td class="tiny">${m.chapter}</td>`;
    allEl.appendChild(tr);
  });

  // EHR summary
  document.getElementById("ehrSummary").textContent = buildEHR(matches, confFlags);
}

/* -----------------------------
   SUBMIT / NAV
----------------------------- */
function showResultsPage(){
  // Require at least some core answered to reduce nonsense
  const coreAnswered = CORE_GATES.filter(g=>answers[g.id]).length;
  if(coreAnswered < 4){
    alert("Answer at least a few Start Here (Core Gates) questions before submitting.");
    return;
  }
  document.getElementById("formPage").classList.add("hidden");
  document.getElementById("resultsPage").classList.remove("hidden");
  renderResults();
  window.scrollTo({top:0,behavior:"smooth"});
}
function backToForm(){
  document.getElementById("resultsPage").classList.add("hidden");
  document.getElementById("formPage").classList.remove("hidden");
  window.scrollTo({top:0,behavior:"smooth"});
}

/* -----------------------------
   SAVE / LOAD / AUTOSAVE
----------------------------- */
const SAVE_KEY = "DSM_SCREENING_OPTION_A_SAVE_v1";

function setAutosaveState(s){ document.getElementById("autosaveState").textContent = s; }

let autosaveTimer = null;
function scheduleAutosave(){
  setAutosaveState("saving…");
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{
    try{
      const payload = { mode: MODE, answers, demographics };
      localStorage.setItem(SAVE_KEY, JSON.stringify(payload));
      setAutosaveState("saved");
    }catch(e){
      setAutosaveState("failed");
    }
  }, 250);
}

function saveNow(){
  try{
    localStorage.setItem(SAVE_KEY, JSON.stringify({mode:MODE, answers, demographics}));
    setAutosaveState("saved");
    alert("Saved.");
  }catch(e){
    alert("Save failed (storage blocked?).");
  }
}

function loadNow(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw){ alert("No saved data found."); return; }
    const data = JSON.parse(raw);
    MODE = data.mode || "adult";
    document.getElementById("modeLabel").textContent = (MODE==="adult" ? "Adult" : "Child/Adolescent");
    // clear + restore
    Object.keys(answers).forEach(k=>delete answers[k]);
    Object.assign(answers, data.answers || {});
    Object.keys(demographics).forEach(k=>demographics[k]="");
    Object.assign(demographics, data.demographics || {});
    renderDemographicsInputs();
    setAutosaveState("loaded");
    refreshAll();
    alert("Loaded.");
  }catch(e){
    alert("Load failed.");
  }
}

function clearSaved(){
  localStorage.removeItem(SAVE_KEY);
  setAutosaveState("cleared");
  alert("Saved data cleared.");
}

/* -----------------------------
   EXPORT JSON
----------------------------- */
function exportJSON(){
  const payload = {
    mode: MODE,
    demographics: {...demographics},
    answers: {...answers},
    computed: computeMatches()
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "dsm_screening_export.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* -----------------------------
   RESET
----------------------------- */
function resetForm(){
  if(!confirm("Reset form answers (does NOT clear saved storage unless you click Clear Saved)?")) return;
  Object.keys(answers).forEach(k=>delete answers[k]);
  Object.keys(demographics).forEach(k=>demographics[k]="");
  renderDemographicsInputs();
  refreshAll();
  scheduleAutosave();
}

/* -----------------------------
   MAIN REFRESH
----------------------------- */
function refreshAll(){
  // rebuild visible list
  visibleQIds.clear();
  renderMode();
  renderCore();
  renderConfounds();
  renderDomains();
  updateProgress();
}

/* -----------------------------
   INIT
----------------------------- */
// Make selectDemOption globally accessible for inline onclick handlers
window.selectDemOption = selectDemOption;

document.addEventListener("DOMContentLoaded", ()=>{
  // wire buttons
  document.getElementById("btnSubmit").onclick = showResultsPage;
  document.getElementById("btnBack").onclick = backToForm;
  document.getElementById("btnPrint").onclick = ()=>window.print();
  document.getElementById("btnReset").onclick = resetForm;
  document.getElementById("btnSaveNow").onclick = saveNow;
  document.getElementById("btnLoad").onclick = loadNow;
  document.getElementById("btnClear").onclick = clearSaved;
  document.getElementById("btnExportJSON").onclick = exportJSON;
  bindDemographics();

  // first render
  refreshAll();

  // try auto-load if exists (quiet)
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(raw){
      const data = JSON.parse(raw);
      MODE = data.mode || MODE;
      Object.assign(answers, data.answers || {});
      Object.keys(demographics).forEach(k=>demographics[k]="");
      Object.assign(demographics, data.demographics || {});
      renderDemographicsInputs();
      setAutosaveState("restored");
      refreshAll();
    }
  }catch(e){}

  setAutosaveState("ready");
});
</script>
</body>
</html>
